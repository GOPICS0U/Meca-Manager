
// index.js - Point d'entr√©e principal du Bot Auto Exotic GTARP
const { Client, GatewayIntentBits, Collection, REST, Routes, PermissionFlagsBits, ChannelType, ActivityType } = require('discord.js');
const fs = require('fs');
const path = require('path');
const config = require('./config.json');
const { setupAutoMod } = require('./utils/automod');
const { setupScheduler } = require('./utils/scheduler');

// Initialisation du client avec les intents n√©cessaires
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.GuildVoiceStates
  ]
});

// Collections pour stocker les commandes et les √©v√©nements
client.commands = new Collection();
client.cooldowns = new Collection();

// Chargement des commandes
const commandsPath = path.join(__dirname, 'commands');
const commandFiles = fs.readdirSync(commandsPath).filter(file => file.endsWith('.js'));

for (const file of commandFiles) {
  const filePath = path.join(commandsPath, file);
  const command = require(filePath);

  if ('data' in command && 'execute' in command) {
    client.commands.set(command.data.name, command);
    console.log(`‚úÖ Commande charg√©e: ${command.data.name}`);
  } else {
    console.warn(`‚ö†Ô∏è La commande ${filePath} n'a pas les propri√©t√©s requises.`);
  }
}

// Chargement des √©v√©nements
const eventsPath = path.join(__dirname, 'events');
const eventFiles = fs.readdirSync(eventsPath).filter(file => file.endsWith('.js'));

for (const file of eventFiles) {
  const filePath = path.join(eventsPath, file);
  const event = require(filePath);

  if (event.once) {
    client.once(event.name, (...args) => event.execute(...args, client));
  } else {
    client.on(event.name, (...args) => event.execute(...args, client));
  }
  console.log(`‚úÖ √âv√©nement charg√©: ${event.name}`);
}

// Fonction pour enregistrer les commandes
async function deployCommands() {
  const commands = [];

  const commandFiles = fs.readdirSync(commandsPath).filter(file => file.endsWith('.js'));

  for (const file of commandFiles) {
    const command = require(`./commands/${file}`);
    commands.push(command.data.toJSON());
  }

  const rest = new REST({ version: '10' }).setToken(config.token);

  try {
    console.log('üîÑ D√©ploiement des commandes slash (/)...');

    await rest.put(
      Routes.applicationCommands(config.clientId),
      { body: commands },
    );

    console.log('‚úÖ Commandes d√©ploy√©es avec succ√®s!');
  } catch (error) {
    console.error('‚ùå Erreur lors du d√©ploiement des commandes:', error);
  }
}

// Fonction pour configurer un serveur Discord complet
async function setupServer(guild) {
  console.log(`üõ†Ô∏è Configuration du serveur: ${guild.name}`);

  try {
    // 1. Cr√©ation des r√¥les (s'ils n'existent pas d√©j√†)
    const roles = {
      'Patron': { color: 'Red', hoist: true, mentionable: true, position: 9, emoji: 'üëë' },
      'Chef M√©canicien': { color: '#FF4500', hoist: true, mentionable: true, position: 8, emoji: 'üîß' },
      'M√©canicien Senior': { color: '#FFA500', hoist: true, mentionable: true, position: 7, emoji: 'üîß' },
      'M√©canicien': { color: '#FFD700', hoist: true, mentionable: true, position: 6, emoji: 'üîß' },
      'M√©canicien Junior': { color: '#FFFF00', hoist: true, mentionable: true, position: 5, emoji: 'üîß' },
      'Stagiaire': { color: '#98FB98', hoist: true, mentionable: true, position: 4, emoji: 'üî∞' },
      'Client': { color: 'Green', hoist: true, mentionable: true, position: 2, emoji: 'üí¨' },
      'BlackListed': { color: 'Grey', hoist: false, mentionable: false, position: 1, emoji: 'üö´' }
    };

    const createdRoles = {};

    for (const [name, settings] of Object.entries(roles)) {
      const existingRole = guild.roles.cache.find(role => role.name === `${settings.emoji} ${name}`);

      if (!existingRole) {
        const newRole = await guild.roles.create({
          name: `${settings.emoji} ${name}`,
          color: settings.color,
          hoist: settings.hoist,
          mentionable: settings.mentionable,
          reason: 'Configuration automatique du serveur Auto Exotic'
        });
        createdRoles[name] = newRole;
        console.log(`‚úÖ R√¥le cr√©√©: ${settings.emoji} ${name}`);
      } else {
        createdRoles[name] = existingRole;
        console.log(`‚ÑπÔ∏è R√¥le d√©j√† existant: ${settings.emoji} ${name}`);
      }
    }

    // 2. Cr√©ation des cat√©gories et salons
    const categories = [
      {
        name: 'INFORMATION',
        channels: [
          { name: 'üìú„Éªr√®glement', type: ChannelType.GuildText },
          { name: 'üì¢„Éªannonces', type: ChannelType.GuildText },
          { name: 'üìç„Éªlocalisation-auto-exotic', type: ChannelType.GuildText },
          { name: 'üìã„Éªtarifs-prestations', type: ChannelType.GuildText }
        ]
      },
      {
        name: 'COMMUNAUT√â',
        channels: [
          { name: 'üí¨„Éªg√©n√©ral', type: ChannelType.GuildText },
          { name: 'üé•„Éªpartage-photos', type: ChannelType.GuildText },
        ]
      },
      {
        name: 'ATELIER',
        private: true,
        restrictedTo: ['Patron', 'Chef M√©canicien', 'M√©canicien Senior', 'M√©canicien', 'M√©canicien Junior', 'Stagiaire'],
        channels: [
          { name: 'üìÇ„Éªdemandes-de-r√©paration', type: ChannelType.GuildText },
          { name: 'üîß„Éªen-cours', type: ChannelType.GuildText },
          { name: '‚úÖ„Éªtermin√©', type: ChannelType.GuildText },
          { name: 'Atelier', type: ChannelType.GuildVoice }
        ]
      }
    ];

    for (const category of categories) {
      let categoryChannel = guild.channels.cache.find(
        c => c.name === category.name && c.type === ChannelType.GuildCategory
      );

      if (!categoryChannel) {
        const permissionOverwrites = [];

        if (category.private) {
          // Restreindre l'acc√®s par d√©faut
          permissionOverwrites.push({
            id: guild.roles.everyone.id,
            deny: [PermissionFlagsBits.ViewChannel]
          });

          // Autoriser l'acc√®s pour les r√¥les sp√©cifi√©s
          for (const roleName of category.restrictedTo) {
            if (createdRoles[roleName]) {
              permissionOverwrites.push({
                id: createdRoles[roleName].id,
                allow: [PermissionFlagsBits.ViewChannel]
              });
            }
          }
        }

        categoryChannel = await guild.channels.create({
          name: category.name,
          type: ChannelType.GuildCategory,
          permissionOverwrites
        });
        console.log(`‚úÖ Cat√©gorie cr√©√©e: ${category.name}`);
      } else {
        console.log(`‚ÑπÔ∏è Cat√©gorie d√©j√† existante: ${category.name}`);
      }

      // Cr√©ation des salons dans cette cat√©gorie
      for (const channel of category.channels) {
        const existingChannel = guild.channels.cache.find(
          c => c.name === channel.name && c.type === channel.type
        );

        if (!existingChannel) {
          const newChannel = await guild.channels.create({
            name: channel.name,
            type: channel.type,
            parent: categoryChannel.id
          });
          console.log(`‚úÖ Salon cr√©√©: ${channel.name}`);

          // Ajouter du contenu initial pour certains canaux
          if (channel.name.includes('r√®glement')) {
            await newChannel.send({
              embeds: [{
                title: 'üìú R√®glement du Auto Exotic Custom',
                description: 'Bienvenue dans notre garage RP. Veuillez respecter ces r√®gles:',
                color: 0xFF0000,
                fields: [
                  { name: '1Ô∏è‚É£ Respect', value: 'Soyez respectueux envers tous les membres du serveur.' },
                  { name: '2Ô∏è‚É£ RP', value: 'Restez dans votre r√¥le et respectez l\'univers GTA RP.' },
                  { name: '3Ô∏è‚É£ Spam', value: 'Pas de spam ou de contenu inappropri√©.' },
                  { name: '4Ô∏è‚É£ Conflits', value: 'R√©glez les diff√©rends en MP ou avec un admin.' },
                  { name: '5Ô∏è‚É£ Clients', value: 'Les clients doivent prendre rendez-vous via la commande /reparation.' }
                ],
                footer: { text: 'Auto Exotic Custom | Le meilleur garage de Los Santos' }
              }]
            });
          } else if (channel.name.includes('localisation-Auto Exotic')) {
            await newChannel.send({
              embeds: [{
                title: 'üìç O√π nous trouver ?',
                description: 'Le garage Auto Exotic est situ√© dans le quartier de Strawberry √† Los Santos.',
                color: 0xFF9900,
                fields: [
                  { name: 'Adresse RP', value: '137 Route 68, Strawberry, Los Santos' },
                  { name: 'Coordonn√©es GTA', value: 'X: -205.5417, Y: -1303.8890, Z: 31.2939' }
                ],
              }]
            });
          } else if (channel.name.includes('tarifs-prestations')) {
            await newChannel.send({
              embeds: [{
                title: 'üìã Tarifs et Prestations',
                description: 'Voici nos tarifs pour les diff√©rentes r√©parations et modifications:',
                color: 0x00FF00,
                fields: [
                  { name: 'üë®‚Äçüîß D√©paneur et Assistance', value: '‚Ä¢ Diagnostiquer probl√®me: 100$\n‚Ä¢ Conseils techniques: Gratuit\n‚Ä¢ Prix de la pr√©station : 500$' },
                  { name: 'üîß R√©parations standard', value: '‚Ä¢ Carrosserie l√©g√®re: 500$\n‚Ä¢ Carrosserie moyenne: 1200$\n‚Ä¢ Carrosserie lourde: 2500$' },
                  { name: '‚öôÔ∏è M√©canique', value: '‚Ä¢ Changement moteur: 7500$\n‚Ä¢ Transmission: 3500$\n‚Ä¢ Freins: 1800$' },
                  { name: 'üé® Personnalisation', value: '‚Ä¢ Peinture compl√®te: 2500$\n‚Ä¢ Jantes: 1500$\n‚Ä¢ Kit carrosserie: 4500-12000$' },
                  { name: 'üöÄ Performance', value: '‚Ä¢ Stage 1: 5000$\n‚Ä¢ Stage 2: 8500$\n‚Ä¢ Stage 3: 15000$' }
                ],
                footer: { text: 'Les prix peuvent varier selon les v√©hicules et les pi√®ces disponibles' }
              }]
            });
          }
        } else {
          console.log(`‚ÑπÔ∏è Salon d√©j√† existant: ${channel.name}`);
        }
      }
    }

    console.log('‚úÖ Configuration du serveur termin√©e!');

  } catch (error) {
    console.error('‚ùå Erreur lors de la configuration du serveur:', error);
  }
}

// √âv√©nement ready
client.once('ready', async () => {
  console.log(`üî• ${client.user.tag} est en ligne!`);

  // D√©ployer les commandes
  await deployCommands();

  // D√©finir une activit√© pour le bot
  client.user.setPresence({
    activities: [{ name: 'üîß Auto Exotic Custom', type: ActivityType.Playing }],
    status: 'online',
  });

  // Configurer l'automod
  setupAutoMod(client);

  // Configurer le planificateur de t√¢ches pour les rapports automatiques
  setupScheduler(client);

  // V√©rifier si le serveur principal existe d√©j√†
  const mainGuild = client.guilds.cache.get(config.mainGuildId);
  if (mainGuild) {
    console.log(`üè† Serveur principal trouv√©: ${mainGuild.name}`);

    // Configurer le serveur
    if (config.autoSetupOnStartup) {
      await setupServer(mainGuild);
    }
  }
});

// La gestion des commandes slash est maintenant dans events/interactionCreate.js

// Gestion des r√©ponses automatiques √† certains mots-cl√©s
client.on('messageCreate', async message => {
  // Ignorer les messages des bots pour √©viter les boucles
  if (message.author.bot) return;

  const content = message.content.toLowerCase();

  // R√©pondre aux mots-cl√©s
  if (content.includes('prix') || content.includes('tarif')) {
    const tarifChannel = message.guild.channels.cache.find(ch => ch.name === 'üìãtarifs-prestations');
    if (tarifChannel) {
      await message.reply(`Vous pouvez consulter tous nos tarifs dans le salon ${tarifChannel} ! üí∞`);
    }
  } else if (content.includes('o√π est Auto Exotic') || content.includes('adresse') || content.includes('localisation')) {
    const localisationChannel = message.guild.channels.cache.find(ch => ch.name === 'üìçlocalisation-Auto Exotic');
    if (localisationChannel) {
      await message.reply(`Vous cherchez notre garage ? Toutes les infos sont dans ${localisationChannel} ! üó∫Ô∏è`);
    }
  }
});

// Gestion de l'√©v√©nement de cr√©ation de serveur (pour cr√©er automatiquement la structure)z
client.on('guildCreate', async guild => {
  console.log(`üéâ Le bot a √©t√© ajout√© au serveur: ${guild.name}`);

  // Configurer le serveur automatiquement
  if (config.autoSetupOnJoin) {
    await setupServer(guild);
  }
});

// Connexion du bot
client.login(config.token);

// Exportation pour utilisation dans d'autres modules
module.exports = { client, setupServer };